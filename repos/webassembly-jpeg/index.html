<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
<script async type="text/javascript" src="webassembly-jpeg.js"></script>
<script>
    var Module = {
        onRuntimeInitialized: () => {
            let setSrcImage = Module.cwrap('setSrcImage', 'number', ['number', 'number']);
            console.log(setSrcImage);
            let decode_qr = Module.cwrap('decode_qr', 'string', ['number', 'number', 'number']);
            console.log(decode_qr);

            loadSrcImage("libjpeg/tokopedia.jpg");

            function loadSrcImage(imgUrl) {
                fetch(imgUrl)
                    .then(response => response.arrayBuffer())
                    .then(initImage)
            }

            function initImage(rawJpeg) {
                let rawJpegAsTypedArray = new Uint8Array(rawJpeg);
                let srcBuf = Module._malloc(rawJpegAsTypedArray.length * rawJpegAsTypedArray.BYTES_PER_ELEMENT);
                Module.writeArrayToMemory(rawJpegAsTypedArray, srcBuf);
                let pImage = setSrcImage(srcBuf, rawJpegAsTypedArray.length);
                width = Module.getValue(pImage + 0, 'i32');
                height = Module.getValue(pImage + 4, 'i32');
                let result = decode_qr(pImage + 8, width, height);
                console.log(result);
                Module._free(srcBuf);
                delete rawJpegAsTypedArray;
            }
        }
    };
</script>
</body>

</html>
